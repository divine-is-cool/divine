<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Access Restricted</title>
<style>
  :root{--bg:#071428;--card:#16212b;--panel:#1e2a34;--muted:#97a6b3;--input:#0f1720;--cta:#3fc3ff;--white:#ffffff;--success:#2ecc71}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);display:flex;align-items:center;justify-content:center;flex-direction:column}
  .card{width:820px;max-width:92%;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:18px;padding:56px 64px;box-shadow:0 18px 50px rgba(3,9,18,0.7);border:1px solid rgba(255,255,255,0.04)}
  h1{margin:0;font-size:44px;color:var(--white);text-align:center;font-weight:800;letter-spacing:0.2px}
  p.lead{margin:18px 0 34px;text-align:center;color:var(--muted);font-size:20px}
  .form{display:flex;flex-direction:column;gap:22px;align-items:stretch}
  input[type="password"]{background:var(--input);border:1px solid rgba(255,255,255,0.03);padding:18px 20px;border-radius:12px;color:#cbd5e1;font-size:18px;outline:none;box-shadow:inset 0 1px 0 rgba(255,255,255,0.03)}
  input[type="password"]::placeholder{color:#26343b}
  button.enter{background:var(--cta);border:none;padding:18px;border-radius:12px;color:var(--white);font-weight:800;font-size:20px;cursor:pointer;box-shadow:0 10px 30px rgba(63,195,255,0.18);transition:transform .08s ease, filter .15s ease}
  button.enter:active{transform:translateY(1px)}
  button.enter:disabled{opacity:.7;cursor:not-allowed;filter:saturate(.8)}
  .msg{height:26px;text-align:center;margin-top:4px;font-weight:700}
  .msg.error{color:#ff6b6b}
  .msg.success{color:var(--success)}
  .disclaimer { color:#ff3b3b; max-width:820px; width:92%; margin:18px auto 0; font-size:0.95rem; text-align:center; line-height:1.3; font-weight:700; }
  .disclaimer a { color:inherit; text-decoration:underline; }
  @media (max-width:520px){ .card{padding:30px 20px} h1{font-size:28px} p.lead{font-size:15px} input[type="password"],button.enter{font-size:16px;padding:14px} .disclaimer{font-size:0.9rem} }
</style>
</head>
<body>
  <div class="card" role="main" aria-labelledby="t">
    <h1 id="t">Restricted Access</h1>
    <p class="lead">Please enter the password to continue.</p>
    <div class="form" aria-live="polite">
      <input id="pw" type="password" placeholder="Password" autocomplete="off" aria-label="Password" />
      <button id="go" class="enter">Enter</button>
      <div id="msg" class="msg" aria-atomic="true"></div>
    </div>
  </div>

  <p class="disclaimer" role="note">
    Proceeding past this page ensures you have read and agree to the <a href="/agreement">agreement</a>.
  </p>

<script>
/*
  Server-validated access gate (static site obeys panel authority).
  - Static site DOES NOT store, fetch, or validate the real PIN.
  - User enters a PIN attempt; we POST it to the panel (/api/auth).
  - Panel validates against its server-side env and returns { allowed: true/false }.
  - We keep the existing UX:
      • "Wrong Password" messaging
      • lockout after 3 failed attempts (client-side throttle)
      • deny during site-lockdown (from panel /api/state)
*/

(function(){
  const COOKIE_NAME = "divine_access";
  const COOKIE_PATH = "/divine";
  const COOKIE_DAYS = 10;

  const LOCK_KEY = "divine_lock_until";
  const FAIL_KEY = "divine_failed_attempts";
  const LOCK_SECONDS = 300;

  // Panel host (single authority)
  const PANEL_HOST = "https://dv-panel-app.sirco.online";
  const STATE_URL = PANEL_HOST + "/api/state";
  const AUTH_URL = PANEL_HOST + "/api/auth";

  const LOCKDOWN_KEY = "divine.panel.lockdown"; // cache "1" | "0"
  const CLIENT_ID_KEY = "divine.clientID";

  function ensureClientID(){
    try {
      const existing = localStorage.getItem(CLIENT_ID_KEY);
      if (existing && typeof existing === "string" && existing.trim()) return existing.trim();
    } catch (e) {}

    let id = "";
    try {
      if (crypto && typeof crypto.randomUUID === "function") id = crypto.randomUUID();
    } catch (e) {}
    if (!id) id = "cid-" + Math.random().toString(36).slice(2) + "-" + Date.now().toString(36);

    try { localStorage.setItem(CLIENT_ID_KEY, id); } catch (e) {}
    return id;
  }

  function setLockdownFlag(enabled) {
    try { localStorage.setItem(LOCKDOWN_KEY, enabled ? "1" : "0"); } catch (e) {}
  }

  function isLockdownEnabledCached() {
    try { return localStorage.getItem(LOCKDOWN_KEY) === "1"; } catch (e) { return false; }
  }

  function parseLockdownEnabledFromState(json) {
    try {
      if (!json) return false;

      if (json.lockdown && typeof json.lockdown.enabled === "boolean") return Boolean(json.lockdown.enabled);

      if (typeof json.lockdown === "boolean") return json.lockdown;
      if (typeof json.lockdown === "number") return json.lockdown !== 0;
      if (typeof json.lockdown === "string") return ["1","true","yes","on","enabled"].includes(json.lockdown.toLowerCase());

      if (json.state && json.state.lockdown && typeof json.state.lockdown.enabled === "boolean") {
        return Boolean(json.state.lockdown.enabled);
      }

      return false;
    } catch (e) {
      return false;
    }
  }

  async function fetchLockdownEnabledLive() {
    try {
      const res = await fetch(STATE_URL, { cache: "no-store" });
      const json = await res.json();
      if (!json || !json.ok) return null;
      const enabled = parseLockdownEnabledFromState(json);
      setLockdownFlag(enabled);
      return enabled;
    } catch (e) {
      return null;
    }
  }

  async function refreshLockdownFlag() {
    const enabled = await fetchLockdownEnabledLive();
    return enabled;
  }

  const pw = document.getElementById("pw");
  const btn = document.getElementById("go");
  const msg = document.getElementById("msg");

  function setBusy(isBusy) {
    try {
      btn.disabled = !!isBusy;
      pw.disabled = !!isBusy;
    } catch (e) {}
  }

  function setCookie() {
    const exp = new Date(Date.now() + COOKIE_DAYS * 24 * 60 * 60 * 1000);
    document.cookie = COOKIE_NAME + "=1; path=" + COOKIE_PATH + "; expires=" + exp.toUTCString() + "; SameSite=Strict";
  }

  function redirectHome() {
    window.location.href = COOKIE_PATH + "/";
  }

  function lockFor(seconds) {
    const until = Date.now() + seconds * 1000;
    localStorage.setItem(LOCK_KEY, String(until));
    updateLock();
  }

  function updateLock() {
    const until = parseInt(localStorage.getItem(LOCK_KEY) || "0", 10);
    if (Date.now() < until) {
      const rem = Math.ceil((until - Date.now()) / 1000);
      pw.disabled = true;
      btn.disabled = true;
      msg.textContent = "Too many failed attempts. Try again in " + rem + "s.";
      msg.className = "msg error";
      setTimeout(updateLock, 500);
    } else {
      pw.disabled = false;
      btn.disabled = false;
      if (!pw.value) {
        msg.textContent = "";
        msg.className = "msg";
      }
      localStorage.removeItem(LOCK_KEY);
    }
  }

  function getFailedAttempts() {
    return parseInt(localStorage.getItem(FAIL_KEY) || "0", 10);
  }

  function setFailedAttempts(n) {
    localStorage.setItem(FAIL_KEY, String(n));
  }

  function resetFailedAttempts() {
    localStorage.removeItem(FAIL_KEY);
  }

  async function denyIfLockdownLiveOrCached() {
    const live = await fetchLockdownEnabledLive();
    const enabled = (live === null) ? isLockdownEnabledCached() : live;

    if (enabled) {
      msg.textContent = "Access Denied";
      msg.className = "msg error";
      return true;
    }
    return false;
  }

  async function validatePinServerSide(pinAttempt) {
    const clientID = ensureClientID();

    const res = await fetch(AUTH_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ clientID, pinAttempt })
    });

    const json = await res.json().catch(() => ({}));
    if (!res.ok || !json || !json.ok) return false;
    return json.allowed === true;
  }

  async function checkPassword(input) {
    if (!input) {
      msg.textContent = "Please enter the password.";
      msg.className = "msg error";
      return;
    }

    setBusy(true);
    try {
      const denied = await denyIfLockdownLiveOrCached();
      if (denied) return;

      const allowed = await validatePinServerSide(input);
      if (allowed) {
        setCookie();
        resetFailedAttempts();
        localStorage.removeItem(LOCK_KEY);
        msg.textContent = "Access Granted! Redirecting...";
        msg.className = "msg success";
        setTimeout(redirectHome, 700);
        return;
      }

      // Wrong PIN attempt path
      const prev = getFailedAttempts();
      const nowAttempts = prev + 1;
      setFailedAttempts(nowAttempts);

      if (nowAttempts < 3) {
        msg.textContent = "Wrong Password";
        msg.className = "msg error";
      } else {
        msg.textContent = "Wrong Password. Too many failed attempts. Locked for " + LOCK_SECONDS + "s.";
        msg.className = "msg error";
        lockFor(LOCK_SECONDS);
      }
    } catch (e) {
      msg.textContent = "Request failed";
      msg.className = "msg error";
    } finally {
      const until = parseInt(localStorage.getItem(LOCK_KEY) || "0", 10);
      if (!(Date.now() < until)) setBusy(false);
    }
  }

  // Keep lockdown flag reasonably fresh
  refreshLockdownFlag();
  window.addEventListener("focus", refreshLockdownFlag);

  btn.addEventListener("click", () => checkPassword(pw.value.trim()));
  pw.addEventListener("keyup", (e) => { if (e.key === "Enter") checkPassword(pw.value.trim()); });

  updateLock();

  // If access cookie already exists, show modal prompt to continue.
  (function(){
    let hasAccess = false;
    try {
      hasAccess = document.cookie.split(';').some(function(c){ return c.trim().indexOf(COOKIE_NAME + '=') === 0; });
    } catch (e) {
      hasAccess = false;
    }
    if (!hasAccess) return;

    const overlay = document.createElement("div");
    overlay.setAttribute("role", "dialog");
    overlay.setAttribute("aria-modal", "true");
    overlay.style.position = "fixed";
    overlay.style.inset = "0";
    overlay.style.background = "rgba(0,0,0,0.55)";
    overlay.style.display = "flex";
    overlay.style.alignItems = "center";
    overlay.style.justifyContent = "center";
    overlay.style.zIndex = "9999";
    overlay.style.padding = "24px";

    const modal = document.createElement("div");
    modal.style.width = "560px";
    modal.style.maxWidth = "92%";
    modal.style.background = "linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02))";
    modal.style.border = "1px solid rgba(255,255,255,0.08)";
    modal.style.borderRadius = "16px";
    modal.style.boxShadow = "0 18px 50px rgba(3,9,18,0.7)";
    modal.style.padding = "26px 26px 22px";
    modal.style.color = "var(--white)";

    const text = document.createElement("div");
    text.textContent = "Looks like you already have access. Would you like to continue?";
    text.style.fontWeight = "800";
    text.style.fontSize = "18px";
    text.style.textAlign = "center";
    text.style.marginBottom = "18px";

    const row = document.createElement("div");
    row.style.display = "flex";
    row.style.gap = "12px";
    row.style.justifyContent = "center";

    const yes = document.createElement("button");
    yes.type = "button";
    yes.textContent = "Yes";
    yes.style.background = "var(--cta)";
    yes.style.border = "none";
    yes.style.padding = "12px 18px";
    yes.style.borderRadius = "12px";
    yes.style.color = "var(--white)";
    yes.style.fontWeight = "800";
    yes.style.fontSize = "16px";
    yes.style.cursor = "pointer";

    const no = document.createElement("button");
    no.type = "button";
    no.textContent = "No";
    no.style.background = "rgba(255,255,255,0.06)";
    no.style.border = "1px solid rgba(255,255,255,0.10)";
    no.style.padding = "12px 18px";
    no.style.borderRadius = "12px";
    no.style.color = "var(--white)";
    no.style.fontWeight = "800";
    no.style.fontSize = "16px";
    no.style.cursor = "pointer";

    function closeModal() {
      if (overlay && overlay.parentNode) overlay.parentNode.removeChild(overlay);
    }

    yes.addEventListener("click", async function(){
      setBusy(true);
      try {
        const denied = await denyIfLockdownLiveOrCached();
        closeModal();
        if (denied) return;
        window.location.href = COOKIE_PATH;
      } finally {
        const until = parseInt(localStorage.getItem(LOCK_KEY) || "0", 10);
        if (!(Date.now() < until)) setBusy(false);
      }
    });

    no.addEventListener("click", function(){
      closeModal();
    });

    row.appendChild(yes);
    row.appendChild(no);
    modal.appendChild(text);
    modal.appendChild(row);
    overlay.appendChild(modal);
    document.body.appendChild(overlay);
  })();
})();
</script>
</body>
</html>
